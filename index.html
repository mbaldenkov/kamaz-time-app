<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–£—á–µ—Ç —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç ‚Äî –ö–ê–ú–ê–ó —Å–µ—Ä–≤–∏—Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <!-- –ò–∫–æ–Ω–∫–∞ –≤–∫–ª–∞–¥–∫–∏ -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
  <!-- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏: –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ -->
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#8aa0b2; --text:#e7eef6; --accent:#4cc2ff; --accent2:#94f38e; --danger:#ff6b6b;
      --border:#223040;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";}
    header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header h1{font-size:18px;margin:0 12px 0 0}
    header .pill{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:6px 10px;display:flex;gap:8px;align-items:center}
    header input[type="text"], header select{
      background:transparent;border:0;color:var(--text);outline:none;width:150px
    }
main{display:grid;grid-template-columns:minmax(300px, 45%) 1fr;gap:14px;padding:14px}
    @media (max-width:960px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row > * { flex: 1 1 auto }
    .muted{color:var(--muted)}
    input, select, button, textarea{
      background:#0e141c;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px;
    }
    input::placeholder{color:#6d8497}
    button{cursor:pointer}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1722}
    .btn.primary{background:linear-gradient(180deg,#0f2230,#11283a);border-color:#1f3448}
    .btn.accent{background:linear-gradient(180deg,#0f2a1a,#0f2f1b);border-color:#1d5136}
    .btn.danger{background:linear-gradient(180deg,#2a1010,#2f1010);border-color:#4b1e1e}
    table{width:100%;border-collapse:collapse}
    th, td{border-bottom:1px dashed var(--border);padding:8px;text-align:left;vertical-align:top}
    th{color:#9cb5c9;font-weight:600}
    tbody tr:hover{background:#0e141c}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .sticky{position:sticky;top:8px}
    .total{font-size:18px}
    .small{font-size:12px}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .link{color:var(--accent);cursor:pointer}
    .spacer{flex:1}

    /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π */
    .worker-select{min-width:120px; flex:1 1 auto;}

    /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É–±–∏—Ä–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞ */
    @media (max-width: 960px) {
      .sticky {
        position: static;
        top: auto;
      }
    }

    /* –£–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∫—Ä–æ–ª–ª –ª–æ–≥–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –±—ã–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–µ–Ω */
    @media (max-width: 960px) {
      .log-wrapper {
        overflow: visible !important;
        max-height: none;
      }

      /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å–µ–∫—Ü–∏–π: —Å–Ω–∞—á–∞–ª–∞ –Ω–∞—Ä—è–¥, –ø–æ—Ç–æ–º –∫–∞—Ç–∞–ª–æ–≥ */
      main {
        display: flex;
        flex-direction: column;
      }
      main > section.card.sticky {
        order: 2;
      }
      main > section.card:not(.sticky) {
        order: 1;
      }
    }

    /* –ü–æ–∑–≤–æ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–∑–º–µ–Ω—è—Ç—å —à–∏—Ä–∏–Ω—É –ø–∞–Ω–µ–ª–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞ –ü–ö */
    @media (min-width: 961px) {
      main > section.card.sticky {
        resize: horizontal;
        overflow: auto;
        min-width: 260px;
        max-width: 600px;
      }
    }

    /* –ö–∞—Ç–∞–ª–æ–≥: –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–µ—Ç (–∫–∞—Ç–∞–ª–æ–≥ —Ç—è–Ω–µ—Ç—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ).
       –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã —Å–ø—Ä–∞–≤–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞—Ä—è–¥–∞. */
    .catalog-wrapper {
      overflow-y: visible;
      max-height: none;
    }
    @media (max-width: 960px) {
      .catalog-wrapper {
        max-height: 40vh;
        overflow-y: auto;
      }
    }

    /* –î–µ–ª–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ –≤ –∫–æ–ª–æ–Ω–∫–µ "–†–∞–±–æ—Ç–∞" –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π */
    #catalogTable td:nth-child(3) {
      white-space: normal;
      word-break: break-word;
      /* –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
      hyphens: auto;
      overflow-wrap: anywhere;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö: —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ "–ú–æ–¥–µ–ª—å" –∏ "–ö–æ–¥" –≤ –∫–∞—Ç–∞–ª–æ–≥–µ */
    @media (max-width: 600px) {
      #catalogTable th:nth-child(1),
      #catalogTable th:nth-child(2),
      #catalogTable td:nth-child(1),
      #catalogTable td:nth-child(2) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>–£—á–µ—Ç —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç</h1>
    <!-- –ü—Ä–æ—Ñ–∏–ª—å —É–±—Ä–∞–Ω: –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ -->
    <div class="pill">
      –ö–∞—Ç–∞–ª–æ–≥ —Ä–∞–±–æ—Ç:
      <input id="catalogFile" type="file" accept=".csv,.txt,.xlsx,.xls" />
      <button class="btn" id="btnSample">–ü—Ä–∏–º–µ—Ä CSV</button>
    </div>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π -->
    <div class="pill">
      –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:
      <input id="workersFile" type="file" accept=".csv,.txt,.xlsx,.xls" />
      <button class="btn" id="btnSampleWorkers">–ü—Ä–∏–º–µ—Ä —Å–ø–∏—Å–∫–∞</button>
    </div>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ Excel –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
    <div class="pill">
      –®–∞–±–ª–æ–Ω:
      <input id="templateFile" type="file" accept=".xlsx,.xls" />
    </div>
    <div class="pill">
      <!-- –ö–Ω–æ–ø–∫–∞ CSV —É–±—Ä–∞–Ω–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel -->
      <button class="btn" id="btnExportExcelLog">–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Ä—è–¥–∞ (Excel)</button>
      <button class="btn" id="btnExportState">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
      <input id="stateFile" type="file" accept=".json" style="display:none"/>
      <button class="btn" id="btnImportState">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å—ë</button>
    </div>
    <div class="spacer"></div>
    <div class="pill">
      <span class="badge">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</span>
    </div>
  </header>

  <main>
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ö–∞—Ç–∞–ª–æ–≥ —Ä–∞–±–æ—Ç -->
    <section class="card sticky">
      <h3 style="margin:6px 0 10px">–ö–∞—Ç–∞–ª–æ–≥ —Ä–∞–±–æ—Ç</h3>
      <div class="row">
        <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫: –º–æ–¥–µ–ª—å, –∫–æ–¥, –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ..." />
        <select id="modelFilter">
          <!-- –û–ø—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </select>
      </div>
      <div class="toolbar">
        <div class="small muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º CSV –∏ Excel (.xlsx) —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: <b>–ù–æ—Ä–º–∞ –≤—Ä–µ–º–µ–Ω–∏, –ú–æ–¥–µ–ª—å —à–∞—Å—Å–∏, –ì—Ä—É–ø–ø–∞, –ü–æ–¥–≥—Ä—É–ø–ø–∞, –û–ø–µ—Ä–∞—Ü–∏—è, –¢—Ä—É–¥–æ–µ–º–∫–æ—Å—Ç—å</b></div>
      </div>
      <!-- –û–±–æ–ª–æ—á–∫–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞. –í—ã—Å–æ—Ç—É –∑–∞–¥–∞—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏. -->
      <div class="catalog-wrapper" style="border:1px solid var(--border);border-radius:10px">
        <table id="catalogTable">
          <thead>
            <tr>
              <th>–ú–æ–¥–µ–ª—å</th>
              <th>–ö–æ–¥</th>
              <th>–†–∞–±–æ—Ç–∞</th>
              <th class="right nowrap">–ù–æ—Ä–º–∞, —á</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="catalogBody">
            <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Ä—è–¥ / –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã -->
    <section class="card">
      <div class="row">
        <h3 style="margin:6px 0 10px">–ù–∞—Ä—è–¥ / –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h3>
        <div class="spacer"></div>
        <button class="btn accent" id="btnSaveLog">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Ä—è–¥</button>
        <button class="btn danger" id="btnClear">–û—á–∏—Å—Ç–∏—Ç—å –Ω–∞—Ä—è–¥</button>
        <button class="btn danger" id="btnResetAll">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>

      <div class="grid2">
        <input id="orderInfo" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (VIN, –≥–æ—Å.–Ω–æ–º–µ—Ä, –∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥ –∏ —Ç.–ø.)">
        <input id="dateField" type="date">
      </div>

      <div class="toolbar">
        <span class="badge">–ú–∞–∫—Å. 3 –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –Ω–∞ —Ä–∞–±–æ—Ç—É</span>
        <span class="badge">–î–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Ä–æ–≤–Ω—É, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 0.1</span>
      </div>

      <div class="log-wrapper" style="overflow:auto;border:1px solid var(--border);border-radius:10px">
        <table id="logTable">
          <thead>
            <tr>
              <th>#</th>
              <th>–ú–æ–¥–µ–ª—å</th>
              <th>–ö–æ–¥</th>
              <th>–†–∞–±–æ—Ç–∞</th>
              <th class="right nowrap">–ù–æ—Ä–º–∞, —á</th>
              <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ (–¥–æ 3)</th>
              <th class="right nowrap">–ù–∞ —á–µ–ª–æ–≤–µ–∫–∞, —á</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="logBody">
            <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ -->
          </tbody>
          <tfoot>
            <tr>
              <th colspan="4" class="right total">–ò—Ç–æ–≥–æ –ø–æ –Ω–∞—Ä—è–¥—É:</th>
              <th id="totalHours" class="right total">0.0</th>
              <th></th>
              <th id="perPersonHint" class="right small muted"></th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <h4 style="margin-top:16px">–ò—Ç–æ–≥–æ –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º</h4>
      <div id="totalsByWorker" class="card" style="background:#0e141c;border-style:dashed"></div>

      <h4 style="margin-top:16px">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Ä—è–¥—ã</h4>
      <div id="historyList" class="card" style="background:#0e141c;border-style:dashed"></div>
    </section>
  </main>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: PapaParse –¥–ª—è CSV –∏ SheetJS (xlsx) –¥–ª—è Excel -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // –ö–ª—é—á localStorage –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–±–µ–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π)
    const LS_KEY = 'kamaz_time_app_v3';

    // –ö–ª—é—á–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∫–∞—Ç–∞–ª–æ–≥ –∏ —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤), –æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
    const GLOBAL_CATALOG_KEY = 'kamaz_global_catalog_v1';
    const GLOBAL_WORKERS_KEY = 'kamaz_global_workers_v1';
    const GLOBAL_TEMPLATE_KEY = 'kamaz_template_data_v1';

    // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let state = {
      // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–±–µ–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π)
      catalog: [], // [{model, code, title, norm_hours}]
      filter: '',
      selectedModel: '', // –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
      workersList: [], // —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –∏–∑ —Ñ–∞–π–ª–∞
      orderInfo: '',
      date: new Date().toISOString().slice(0,10),
      log: [], // [{id, model, code, title, norm_hours, workers:[name1,name2,name3]}]
      history: [] // –º–∞—Å—Å–∏–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Ä—è–¥–æ–≤: {id, date, orderInfo, log}
      ,
      templateData: null // ArrayBuffer –¥–ª—è Excel-—à–∞–±–ª–æ–Ω–∞ (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω)
    };

    // –£—Ç–∏–ª–∏—Ç—ã
    const toOneDecimal = (x) => Math.round((Number(x)||0)*10)/10;
    /**
     * –†–∞—Å—á—ë—Ç –Ω–æ—Ä–º—ã –Ω–∞ –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º –¥–æ –¥–µ—Å—è—Ç—ã—Ö.
     * –ï—Å–ª–∏ –∏—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 0.1 –∏ –±–æ–ª—å—à–µ 0, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0.1 (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ),
     * —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω—É–ª–µ–π –≤ –æ—Ç—á—ë—Ç–µ. –ù–æ–ª—å –æ—Å—Ç–∞—ë—Ç—Å—è –Ω—É–ª—ë–º.
     * @param {number} total - –æ–±—â–∞—è –Ω–æ—Ä–º–∞ —Ä–∞–±–æ—Ç—ã
     * @param {number} count - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (>=1)
     */
    const calcPerPerson = (total, count) => {
      const base = (Number(total) || 0) / (count || 1);
      if(base <= 0) return 0;
      const rounded = toOneDecimal(base);
      return rounded < 0.1 ? 0.1 : rounded;
    };
    const sanitize = (s) => (s??'').toString().trim();
    const byId = (id) => document.getElementById(id);
    const uuid = () => Math.random().toString(36).slice(2,9);

    /**
     * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏: —É–±–∏—Ä–∞–µ—Ç –¥–µ—Å—è—Ç–∏—á–Ω—É—é —á–∞—Å—Ç—å —É —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–¥–æ–≤.
     * –ü—Ä–∏–º–µ—Ä—ã: "43118.0" ‚Üí "43118", 43118 ‚Üí "43118".
     */
    function normalizeModel(value){
      if(value === undefined || value === null) return '';
      // –µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ ‚Äì –±–µ—Ä—ë–º —Ü–µ–ª—É—é —á–∞—Å—Ç—å
      if(typeof value === 'number'){
        return parseInt(value, 10).toString();
      }
      let s = String(value).trim();
      // –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫—É, –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç—å
      const m = s.match(/^(-?\d+)(?:\.0+)?$/);
      if(m) return m[1];
      return s;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    function save(){
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ) –≤ LocalStorage
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{
          state = JSON.parse(raw);
          // –ù–∞–∑–Ω–∞—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–∞–±–æ—Ç—ã –∫–∞—Ç–∞–ª–æ–≥–∞, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π)
          if(Array.isArray(state.catalog)){
            let modified = false;
            state.catalog.forEach(r => {
              if(!r.id){ r.id = uuid(); modified = true; }
            });
            if(modified) save();
          }
        }catch(e){
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', e);
        }
      }else{
        // –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ—Ç, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        state = {
          catalog: [],
          filter: '',
          selectedModel: '',
          workersList: [],
          orderInfo: '',
          date: new Date().toISOString().slice(0,10),
          log: [],
          history: []
        };
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        loadGlobalData();
      }
      renderAll();
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ (–æ–±—â–∏–µ) –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ä–∞–±–æ—Ç –∏ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
     * –∏–∑ LocalStorage –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ state.catalog –∏ state.workersList.
     */
    function loadGlobalData(){
      // –ö–∞—Ç–∞–ª–æ–≥
      const catRaw = localStorage.getItem(GLOBAL_CATALOG_KEY);
      if(catRaw){
        try{
          const cat = JSON.parse(catRaw);
          if(Array.isArray(cat)){
            // –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º id –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
            cat.forEach(item => {
              if(!item.id) item.id = uuid();
            });
            state.catalog = cat;
          }
        }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥', e); }
      }
      // –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
      const wRaw = localStorage.getItem(GLOBAL_WORKERS_KEY);
      if(wRaw){
        try{
          const workers = JSON.parse(wRaw);
          if(Array.isArray(workers)){
            state.workersList = workers;
          }
        }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤', e); }
      }

      // –®–∞–±–ª–æ–Ω Excel
      const tRaw = localStorage.getItem(GLOBAL_TEMPLATE_KEY);
      if(tRaw){
        try{
          // tRaw —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ base64 —Ñ–æ—Ä–º–∞—Ç–µ, –¥–µ–∫–æ–¥–∏—Ä—É–µ–º
          const binaryString = atob(tRaw);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for(let i=0; i<len; i++) bytes[i] = binaryString.charCodeAt(i);
          state.templateData = bytes.buffer;
        }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω', e); }
      }
    }

    // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ —Ä–∞–±–æ—Ç
    function renderCatalog(){
      const tbody = byId('catalogBody');
      tbody.innerHTML = '';
      const q = state.filter.toLowerCase();
      let rows = state.catalog;
      // –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
      if(state.selectedModel){
        rows = rows.filter(r => String(r.model) === String(state.selectedModel));
      }
      // –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
      rows = rows.filter(r => {
        const hay = `${r.model} ${r.code} ${r.title}`.toLowerCase();
        return hay.includes(q);
      }).slice(0,500); // –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–≥—Ä–æ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç—Ä–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if(rows.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" class="muted" style="text-align:center;padding:20px">–ù–µ—Ç —Ä–∞–±–æ—Ç</td>`;
        tbody.appendChild(tr);
        return;
      }
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.model)}</td>
          <td>${escapeHtml(r.code)}</td>
          <td>${escapeHtml(r.title)}</td>
          <td class="right">${Number(r.norm_hours).toFixed(1)}</td>
          <td><button class="btn primary" data-add="${escapeAttr(r.id)}">–î–æ–±–∞–≤–∏—Ç—å</button></td>
        `;
        tbody.appendChild(tr);
      }
    }

    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç (–Ω–∞—Ä—è–¥)
    function renderLog(){
      const tbody = byId('logBody');
      tbody.innerHTML = '';
      state.log.forEach((item, idx) => {
        const nExec = item.workers.filter(Boolean).length || 1;
        const perPerson = toOneDecimal((item.norm_hours || 0) / nExec);

        const tr = document.createElement('tr');
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π: –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ workersList, –∏—Å–ø–æ–ª—å–∑—É–µ–º <select>, –∏–Ω–∞—á–µ <input>
        let workersHtml = '';
        if(state.workersList && state.workersList.length){
          // —Å–æ–∑–¥–∞–µ–º select –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ—Ç–∞
          workersHtml = [0,1,2].map(i => {
            const selectedValue = item.workers[i] || '';
            let opts = '<option value=""></option>';
            for(const w of state.workersList){
              const sel = (String(w) === String(selectedValue)) ? ' selected' : '';
              opts += `<option value="${escapeAttr(w)}"${sel}>${escapeHtml(w)}</option>`;
            }
            return `<select class="worker-select" data-id="${item.id}" data-slot="${i}">${opts}</select>`;
          }).join('');
        } else {
          // –æ–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
          workersHtml = [0,1,2].map(i => `
            <input class="worker" data-id="${item.id}" data-slot="${i}" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ${i+1}" value="${escapeAttr(item.workers[i]||'')}">
          `).join('');
        }
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHtml(item.model)}</td>
          <td>${escapeHtml(item.code)}</td>
          <td>${escapeHtml(item.title)}</td>
          <td class="right">${Number(item.norm_hours).toFixed(1)}</td>
          <td>
            <div class="row" style="gap:6px">
              ${workersHtml}
            </div>
          </td>
          <td class="right">${perPerson.toFixed(1)}</td>
          <td><span class="link" data-del="${item.id}">–£–¥–∞–ª–∏—Ç—å</span></td>
        `;
        tbody.appendChild(tr);
      });

      // –ò—Ç–æ–≥–æ –ø–æ –Ω–∞—Ä—è–¥—É
      const total = toOneDecimal(state.log.reduce((s,x)=>s + (Number(x.norm_hours)||0),0));
      byId('totalHours').textContent = total.toFixed(1);
      byId('perPersonHint').textContent = state.log.length ? '–î–æ–ª–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –∫–∞–∂–¥–æ–π —Ä–∞–±–æ—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ' : '';

      renderTotalsByWorker();
    }

    // –†–µ–Ω–¥–µ—Ä –∏—Ç–æ–≥–æ–≤ –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º
    function renderTotalsByWorker(){
      const map = new Map(); // name -> hours
      for(const it of state.log){
        const workers = it.workers.filter(w => sanitize(w));
        const n = workers.length || 1;
        const per = toOneDecimal((Number(it.norm_hours)||0)/n);
        for(const w of workers.length ? workers : ['(–±–µ–∑ –∏–º–µ–Ω–∏)']){
          map.set(w, toOneDecimal((map.get(w)||0) + per));
        }
      }
      const entries = Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0], 'ru'));
      const box = byId('totalsByWorker');
      if(entries.length===0){ box.innerHTML = '<span class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</span>'; return; }
      let html = '<table><thead><tr><th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th><th class="right">–°—É–º–º–∞, —á</th></tr></thead><tbody>';
      for(const [name, hrs] of entries){
        html += `<tr><td>${escapeHtml(name)}</td><td class="right">${hrs.toFixed(1)}</td></tr>`;
      }
      html += '</tbody></table>';
      box.innerHTML = html;
    }

    // –û–±—â–∏–π —Ä–µ–Ω–¥–µ—Ä
    function renderAll(){
      // –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
      byId('orderInfo').value = state.orderInfo || '';
      byId('dateField').value = state.date || new Date().toISOString().slice(0,10);
      renderModelFilter();
      renderCatalog();
      renderLog();
      renderHistory();
    }

    // –†–µ–Ω–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Ä—è–¥–æ–≤
    function renderHistory(){
      const box = byId('historyList');
      if(!state.history || state.history.length === 0){
        box.innerHTML = '<span class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</span>';
        return;
      }
      let html = '<table><thead><tr><th>#</th><th>–î–∞—Ç–∞</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th><th class="right nowrap">–†–∞–±–æ—Ç</th><th class="right nowrap">–ß–∞—Å—ã</th><th></th></tr></thead><tbody>';
      state.history.forEach((rec, idx) => {
        // –≤—ã—á–∏—Å–ª—è–µ–º —Å—É–º–º—É —á–∞—Å–æ–≤
        const total = rec.log.reduce((s, x) => s + (Number(x.norm_hours) || 0), 0);
        html += `<tr>` +
          `<td>${idx+1}</td>` +
          `<td>${escapeHtml(rec.date)}</td>` +
          `<td>${escapeHtml(rec.orderInfo || '')}</td>` +
          `<td class="right">${rec.log.length}</td>` +
          `<td class="right">${toOneDecimal(total).toFixed(1)}</td>` +
          `<td><span class="link" data-hist-open="${rec.id}">–û—Ç–∫—Ä—ã—Ç—å</span> | <span class="link" data-hist-delete="${rec.id}">–£–¥–∞–ª–∏—Ç—å</span></td>` +
          `</tr>`;
      });
      html += '</tbody></table>';
      box.innerHTML = html;
    }

    // –†–µ–Ω–¥–µ—Ä –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
    function renderModelFilter(){
      const select = byId('modelFilter');
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      const prev = state.selectedModel;
      // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
      const models = Array.from(new Set(state.catalog.map(r => String(r.model)))).sort((a,b) => a.localeCompare(b,'ru'));
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ, —Å–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
      if(prev && !models.includes(String(prev))){
        state.selectedModel = '';
      }
      // –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–º–µ—Ç–∫—É
      let html = '<option value="">–í—Å–µ –º–æ–¥–µ–ª–∏</option>';
      for(const m of models){
        const selected = (String(m) === String(prev)) ? ' selected' : '';
        html += `<option value="${escapeAttr(m)}"${selected}>${escapeHtml(m)}</option>`;
      }
      select.innerHTML = html;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('click', (e)=>{
      const add = e.target?.dataset?.add;
      if(add){
        // –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É id
        const r = state.catalog.find(x => x.id === add);
        if(r){
          state.log.push({
            id: uuid(),
            model: r.model, code: r.code, title: r.title,
            norm_hours: Number(r.norm_hours)||0,
            workers: ['', '', '']
          });
          save(); renderLog();
        }
      }
      const del = e.target?.dataset?.del;
      if(del){
        state.log = state.log.filter(x => x.id !== del);
        save(); renderLog();
      }
    });

    byId('search').addEventListener('input', (e)=>{
      state.filter = e.target.value || '';
      renderCatalog();
    });

    byId('orderInfo').addEventListener('input', (e)=>{
      state.orderInfo = e.target.value || '';
      save();
    });
    byId('dateField').addEventListener('change', (e)=>{
      state.date = e.target.value || new Date().toISOString().slice(0,10);
      save();
    });

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–≤–æ–¥–∞)
    byId('logBody').addEventListener('input', (e)=>{
      if(e.target.classList.contains('worker')){
        const id = e.target.dataset.id;
        const slot = Number(e.target.dataset.slot);
        const row = state.log.find(x => x.id === id);
        if(row){
          row.workers[slot] = e.target.value;
          save(); renderTotalsByWorker();
        }
      }
    });

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –¥–ª—è <select>
    byId('logBody').addEventListener('change', (e)=>{
      if(e.target.classList.contains('worker-select')){
        const id = e.target.dataset.id;
        const slot = Number(e.target.dataset.slot);
        const row = state.log.find(x => x.id === id);
        if(row){
          row.workers[slot] = e.target.value;
          save(); renderTotalsByWorker();
        }
      }
    });

    // –û—á–∏—Å—Ç–∏—Ç—å –Ω–∞—Ä—è–¥
    byId('btnClear').addEventListener('click', ()=>{
      if(confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π –Ω–∞—Ä—è–¥?')){
        state.log = [];
        save(); renderAll();
      }
    });

    // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë (–ª–æ–≥, –∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ, –¥–∞—Ç–∞)
    byId('btnResetAll').addEventListener('click', ()=>{
      if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Ç–µ–∫—É—â–∏–π –Ω–∞—Ä—è–¥ –∏ –∏—Å—Ç–æ—Ä–∏—é)?')){
        state.log = [];
        state.history = [];
        state.orderInfo = '';
        state.date = new Date().toISOString().slice(0,10);
        save();
        renderAll();
        alert('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
      }
    });

    // –ü—Ä–æ—Ñ–∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ (CSV –∏–ª–∏ Excel)
    byId('catalogFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      if(ext === 'csv' || ext === 'txt'){
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => h.trim().toLowerCase(),
          complete: (res)=>{
            const rows = res.data.map(x => ({
              id: uuid(),
              model: normalizeModel(sanitize(x.model)),
              code: sanitize(x.code),
              title: sanitize(x.title),
              norm_hours: Number((x.norm_hours||'').toString().replace(',', '.')) || 0
            })).filter(x => x.model || x.code || x.title);
            if(!rows.length){ alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Ç—Ä–æ–∫. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–ª–æ–Ω–∫–∏: model, code, title, norm_hours'); return; }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–∞–ª–æ–≥
            state.catalog = rows;
            // –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ —Ñ–∏–ª—å—Ç—Ä –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞
            state.filter = '';
            state.selectedModel = '';
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥
            try{
              localStorage.setItem(GLOBAL_CATALOG_KEY, JSON.stringify(rows));
            }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥', e); }
            save();
            renderModelFilter();
            renderCatalog();
            alert('–ö–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω: ' + rows.length + ' —Å—Ç—Ä–æ–∫');
          },
          error: (err)=> alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV: ' + err)
        });
      } else if(ext === 'xlsx' || ext === 'xls'){
        const reader = new FileReader();
        reader.onload = function(evt){
          try{
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type:'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫; header:1 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤—É–º–µ—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤
            const jsonArr = XLSX.utils.sheet_to_json(worksheet, {header:1});
            if(!jsonArr || jsonArr.length < 2){
              alert('–õ–∏—Å—Ç –ø—É—Å—Ç –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É');
              return;
            }
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            const header = jsonArr[0].map(h => (h||'').toString().trim().toLowerCase());
            const idxNorm = header.findIndex(h => h.startsWith('–Ω–æ—Ä–º–∞'));
            const idxChassis = header.findIndex(h => h.includes('—à–∞—Å—Å–∏'));
            const idxSubGroup = header.findIndex(h => h.startsWith('–ø–æ–¥–≥—Ä—É–ø–ø–∞'));
            const idxGroup = header.findIndex(h => h.startsWith('–≥—Ä—É–ø–ø–∞'));
            const idxOperation = header.findIndex(h => h.startsWith('–æ–ø–µ—Ä–∞'));
            const idxLabor = header.findIndex(h => h.startsWith('—Ç—Ä—É–¥'));
            const rows = [];
            for(let i=1; i<jsonArr.length; i++){
              const row = jsonArr[i];
              if(!row) continue;
              const op = row[idxOperation];
              if(!op) continue;
              let labor = row[idxLabor];
              labor = labor !== undefined && labor !== null ? String(labor).replace(',', '.') : '0';
              const normHours = parseFloat(labor) || 0;
              // derive model: use chassis if present, else extract digits from norm column
              let model = '';
              const chassis = row[idxChassis];
              if(chassis !== undefined && chassis !== null && String(chassis).trim() !== ''){
                model = String(chassis).trim();
              } else {
                const norm = row[idxNorm] || '';
                const m = String(norm).match(/\d{4}/);
                model = m ? m[0] : String(norm).trim();
              }
              // derive code: extract numeric prefix from sub-group; fallback to group
              let code = '';
              const sub = row[idxSubGroup];
              if(sub !== undefined && sub !== null && String(sub).trim() !== ''){
                const m = String(sub).match(/^(\d+)/);
                code = m ? m[1] : String(sub).trim();
              } else {
                const grp = row[idxGroup];
                if(grp !== undefined && grp !== null && String(grp).trim() !== ''){
                  const m = String(grp).match(/^(\d+)/);
                  code = m ? m[1] : String(grp).trim();
                }
              }
              rows.push({
                id: uuid(),
                model: normalizeModel(sanitize(model)),
                code: sanitize(code),
                title: sanitize(String(op)),
                norm_hours: normHours
              });
            }
            if(!rows.length){
              alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Ç—Ä–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∏ "–û–ø–µ—Ä–∞—Ü–∏—è" –∏ "–¢—Ä—É–¥–æ–µ–º–∫–æ—Å—Ç—å" –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
              return;
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–∞–ª–æ–≥
            state.catalog = rows;
            // –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ —Ñ–∏–ª—å—Ç—Ä –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞
            state.filter = '';
            state.selectedModel = '';
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥
            try{
              localStorage.setItem(GLOBAL_CATALOG_KEY, JSON.stringify(rows));
            }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥', e); }
            save();
            renderModelFilter();
            renderCatalog();
            alert('–ö–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω: ' + rows.length + ' —Å—Ç—Ä–æ–∫');
          }catch(err){
            console.error(err);
            alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel: ' + err.message);
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV, TXT –∏–ª–∏ Excel (.xlsx, .xls)');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (—Ñ–∞–º–∏–ª–∏–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª—ã)
    byId('workersFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
      const setWorkers = (list) => {
        // –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ, —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
        const names = Array.from(new Set(list.map(s => sanitize(s)).filter(s => s)) ).sort((a,b)=> a.localeCompare(b, 'ru'));
        if(!names.length){
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–º–µ–Ω–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ');
          return;
        }
        state.workersList = names;
        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        try{
          localStorage.setItem(GLOBAL_WORKERS_KEY, JSON.stringify(names));
        }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤', e); }
        save();
        renderLog();
        alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π: ' + names.length);
      };
      if(ext === 'csv' || ext === 'txt'){
        // —á–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç –∏ —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ —Å—Ç—Ä–æ–∫–∞–º
        const reader = new FileReader();
        reader.onload = (evt) => {
          const text = evt.target.result || '';
          // –†–∞–∑–±–∏—Ç—å —Å—Ç—Ä–æ–∫–∏, —É–¥–∞–ª–∏—Ç—å –ø—É—Å—Ç—ã–µ
          const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
          setWorkers(lines);
        };
        reader.readAsText(file, 'utf-8');
      } else if(ext === 'xlsx' || ext === 'xls'){
        const reader = new FileReader();
        reader.onload = function(evt){
          try{
            const data = new Uint8Array(evt.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
            const names = [];
            for(let i=0; i<rows.length; i++){
              const row = rows[i];
              if(row && row[0]){
                names.push(String(row[0]).trim());
              }
            }
            setWorkers(names);
          }catch(err){
            console.error(err);
            alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel: ' + err.message);
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–ø–∏—Å–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π. –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV, TXT –∏–ª–∏ Excel (.xlsx, .xls)');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ Excel
    byId('templateFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      if(ext !== 'xlsx' && ext !== 'xls'){
        alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã Excel (.xlsx, .xls)');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(evt){
        const buffer = evt.target.result;
        state.templateData = buffer;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –≤ base64-—Ñ–æ—Ä–º–∞—Ç–µ
        try{
          const bytes = new Uint8Array(buffer);
          let binary = '';
          for(let i=0; i<bytes.length; i++) binary += String.fromCharCode(bytes[i]);
          const b64 = btoa(binary);
          localStorage.setItem(GLOBAL_TEMPLATE_KEY, b64);
        }catch(err){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω', err); }
        alert('–®–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω');
      };
      reader.readAsArrayBuffer(file);
    });

    // –ö–Ω–æ–ø–∫–∞: –ø—Ä–∏–º–µ—Ä —Å–ø–∏—Å–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
    byId('btnSampleWorkers').addEventListener('click', () => {
      const sample = [
        '–ò–≤–∞–Ω–æ–≤ –ò.–ò.',
        '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.',
        '–°–∏–¥–æ—Ä–æ–≤ –°.–°.',
        '–§—ë–¥–æ—Ä–æ–≤ –§.–§.'
      ].join('\n');
      downloadText('workers_sample.csv', sample);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –º–æ–¥–µ–ª–∏
    byId('modelFilter').addEventListener('change', (e)=>{
      state.selectedModel = e.target.value || '';
      save();
      renderCatalog();
    });

    // –ü—Ä–∏–º–µ—Ä CSV
    byId('btnSample').addEventListener('click', ()=>{
      const sample = [
        'model,code,title,norm_hours',
        '43118,ENG-101,–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è,2.5',
        '43118,BRK-210,–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Ç–æ—Ä–º–æ–∑–æ–≤,1.2',
        '6520,CLT-330,–ó–∞–º–µ–Ω–∞ —Å—Ü–µ–ø–ª–µ–Ω–∏—è,8.0',
        '6520,SUS-510,–ó–∞–º–µ–Ω–∞ –∞–º–æ—Ä—Ç–∏–∑–∞—Ç–æ—Ä–æ–≤ (–æ—Å—å),3.5'
      ].join('\n');
      downloadText('catalog_sample.csv', sample);
    });

    // –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Ä—è–¥–∞ (CSV) –æ—Ç–∫–ª—é—á–µ–Ω

    // –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Ä—è–¥–∞ –≤ Excel
    byId('btnExportExcelLog').addEventListener('click', ()=>{
      // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω —à–∞–±–ª–æ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if(state.templateData){
        exportWithTemplate();
        return;
      }
      // –ï—Å–ª–∏ —à–∞–±–ª–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
      const wb = XLSX.utils.book_new();
      const ws = {};
      // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: –î–∞—Ç–∞ –∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –≤–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ
      const info = `–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞: ${state.date || ''}  –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${state.orderInfo || ''}`;
      // –û—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –ø—É—Å—Ç–æ–π –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –±–ª–∞–Ω–∫—É
      ws['A2'] = { t:'s', v: info, s:{ alignment: { wrapText: true } } };
      // –°—Ç—Ä–æ–∫–∞ 3 –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –¥–ª—è –æ—Ç—Å—Ç—É–ø–∞
      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç—Ä–æ–∫–∏ 4 (1‚Äë–∏–Ω–¥–µ–∫—Å)
      let rowIndex = 4;
      let counter = 1;
      // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π —è—á–µ–µ–∫
      const merges = [];
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∏–ª–µ–π —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–Ω–æ—Å–∞
      const makeStyle = (wrap=false) => ({
        border: {
          top: {style:'thin'},
          bottom:{style:'thin'},
          left:{style:'thin'},
          right:{style:'thin'}
        },
        alignment: { vertical: 'top', wrapText: wrap }
      });
      for(const it of state.log){
        const wsList = it.workers.filter(Boolean);
        const normTotal = parseFloat((Number(it.norm_hours)||0).toFixed(1));
        const countWorkers = wsList.length > 0 ? wsList.length : 1;
        // –ù–æ—Ä–º–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ —Å —É—á—ë—Ç–æ–º –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≤–≤–µ—Ä—Ö –¥–æ 0.1
        const perVal = calcPerPerson(normTotal, countWorkers);
        const rStart = rowIndex - 1; // –Ω—É–ª–µ–≤–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
        const rCount = wsList.length > 0 ? wsList.length : 1;
        const rEnd = rStart + rCount - 1;
        if(rCount > 1){
          // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —è—á–µ–π–∫–∏ —Å —Ä–∞–±–æ—Ç–æ–π –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫
          merges.push({ s: { r: rStart, c: 1 }, e: { r: rEnd, c: 1 } });
        }
        if(wsList.length === 0){
          const r = rowIndex - 1;
          // –ù–æ–º–µ—Ä
          ws[XLSX.utils.encode_cell({ r, c: 0 })] = { t:'n', v: counter, s: makeStyle(false) };
          // –†–∞–±–æ—Ç–∞
          ws[XLSX.utils.encode_cell({ r, c: 1 })] = { t:'s', v: it.title, s: makeStyle(true) };
          // –ù–æ—Ä–º–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –Ω–µ—Ç, –¥–µ–ª–∏—Ç—å –Ω–µ –Ω—É–∂–Ω–æ)
          ws[XLSX.utils.encode_cell({ r, c: 2 })] = { t:'n', v: perVal, s: makeStyle(false) };
          // –î–∞—Ç–∞
          ws[XLSX.utils.encode_cell({ r, c: 3 })] = { t:'s', v: state.date || '', s: makeStyle(false) };
          // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏
          ws[XLSX.utils.encode_cell({ r, c: 4 })] = { t:'s', v: '', s: makeStyle(true) };
          rowIndex++;
          counter++;
        } else {
          wsList.forEach((w, idx) => {
            const r = rowIndex - 1;
            if(idx === 0){
              // –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –Ω–æ–º–µ—Ä, —Ä–∞–±–æ—Ç–∞, –Ω–æ—Ä–º–∞, –¥–∞—Ç–∞, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
              ws[XLSX.utils.encode_cell({ r, c: 0 })] = { t:'n', v: counter, s: makeStyle(false) };
              ws[XLSX.utils.encode_cell({ r, c: 1 })] = { t:'s', v: it.title, s: makeStyle(true) };
              ws[XLSX.utils.encode_cell({ r, c: 2 })] = { t:'n', v: perVal, s: makeStyle(false) };
              ws[XLSX.utils.encode_cell({ r, c: 3 })] = { t:'s', v: state.date || '', s: makeStyle(false) };
              ws[XLSX.utils.encode_cell({ r, c: 4 })] = { t:'s', v: w, s: makeStyle(true) };
            } else {
              // –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏: —Ç–æ–ª—å–∫–æ –Ω–æ—Ä–º–∞, –¥–∞—Ç–∞ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
              ws[XLSX.utils.encode_cell({ r, c: 2 })] = { t:'n', v: perVal, s: makeStyle(false) };
              ws[XLSX.utils.encode_cell({ r, c: 3 })] = { t:'s', v: state.date || '', s: makeStyle(false) };
              ws[XLSX.utils.encode_cell({ r, c: 4 })] = { t:'s', v: w, s: makeStyle(true) };
            }
            rowIndex++;
          });
          counter++;
        }
      }
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
      const endRow = rowIndex - 1;
      ws['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: endRow - 1, c: 4 } });
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –ø–µ—á–∞—Ç–∏ –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É
      ws['!cols'] = [
        { wch: 5 },   // ‚Ññ
        { wch: 50 },  // –†–∞–±–æ—Ç–∞ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —à–∏—Ä–æ–∫–∏–π —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è –ø–µ—á–∞—Ç–∏
        { wch: 10 },  // –ù–æ—Ä–º–∞
        { wch: 12 },  // –î–∞—Ç–∞
        { wch: 30 }   // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏
      ];
      // –ó–∞–º–æ—Ä–æ–∑–∏—Ç—å –ø–µ—Ä–≤—ã–µ —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ (–ø—É—Å—Ç–∞—è, –¥–∞—Ç–∞/–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –∏ –ø—É—Å—Ç–∞—è) –¥–ª—è –ø–µ—á–∞—Ç–∏
      ws['!freeze'] = { xSplit: 0, ySplit: 3, topLeftCell:'A4' };
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —è—á–µ–µ–∫
      if(merges.length){
        ws['!merges'] = merges;
      }
      XLSX.utils.book_append_sheet(wb, ws, '–ù–∞—Ä—è–¥');
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º
        const totals = {};
      for(const it of state.log){
        const wsList = it.workers.filter(Boolean);
        const n = (wsList.length) || 1;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ –∏ –¥–ª—è —Å—Ç—Ä–æ–∫, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω—É–ª–µ–π
        const per = calcPerPerson(Number(it.norm_hours)||0, n);
        if(wsList.length === 0){
          totals['(–±–µ–∑ –∏–º–µ–Ω–∏)'] = toOneDecimal((totals['(–±–µ–∑ –∏–º–µ–Ω–∏)']||0) + per);
        } else {
          for(const w of wsList){
            totals[w] = toOneDecimal((totals[w]||0) + per);
          }
        }
      }
      const summaryData = [];
      summaryData.push(['–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å','–°—É–º–º–∞, —á']);
      Object.keys(totals).sort((a,b) => a.localeCompare(b, 'ru')).forEach(name => {
        summaryData.push([name, totals[name].toFixed(1)]);
      });
      const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
      ws2['!cols'] = [ {wch: 25}, {wch: 12} ];
      ws2['!freeze'] = { xSplit: 0, ySplit: 1, topLeftCell:'A2' };
      ws2['!autofilter'] = { ref: 'A1:B1' };
      XLSX.utils.book_append_sheet(wb, ws2, '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏');
      // –ü–∏—à–µ–º —Ñ–∞–π–ª
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbout], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      downloadBlob(`narjad_${state.date}.xlsx`, blob);
    });

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –Ω–∞—Ä—è–¥, –ø–æ–¥—Å—Ç–∞–≤–ª—è—è –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω Excel
     */
    function exportWithTemplate(){
      try{
        if(!state.templateData){
          alert('–®–∞–±–ª–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
          return;
        }
        // –ß–∏—Ç–∞–µ–º —à–∞–±–ª–æ–Ω
        const wb = XLSX.read(state.templateData, {type:'array'});
        const firstSheetName = wb.SheetNames[0];
        const ws = wb.Sheets[firstSheetName];
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç—Ä–æ–∫—É —Å –¥–∞—Ç–æ–π –∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ–º –≤–æ –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É, –∫–æ–ª–æ–Ω–∫—É A
        const infoText = `–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞: ${state.date || ''}  –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${state.orderInfo || ''}`;
        // –£—Å—Ç–∞–Ω–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ —è—á–µ–π–∫–∏ A2
        ws['A2'] = ws['A2'] || {};
        ws['A2'].t = 's';
        ws['A2'].v = infoText;
        // –í–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ –∏ –≥—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±—â–µ–π —Å—Ç—Ä–æ–∫–∏
        ws['A2'].s = {
          border: {
            top: {style:'thin'},
            bottom: {style:'thin'},
            left: {style:'thin'},
            right: {style:'thin'}
          },
          alignment: { vertical: 'top', wrapText: true }
        };
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–æ–≤, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –ø–æ–º–µ—â–∞–ª—Å—è –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è
        ws['!cols'] = [
          { wch: 5 },   // ‚Ññ
          { wch: 50 },  // –†–∞–±–æ—Ç–∞ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —à–∏—Ä–æ–∫–∏–π —Å—Ç–æ–ª–±–µ—Ü
          { wch: 10 },  // –ù–æ—Ä–º–∞
          { wch: 12 },  // –î–∞—Ç–∞
          { wch: 30 }   // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
        ];
        // –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (–¥–æ —Ç—Ä–µ—Ç—å–µ–π —Å—Ç—Ä–æ–∫–∏)
        ws['!freeze'] = { xSplit: 0, ySplit: 3, topLeftCell: 'A4' };
        // –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–∞ 4, –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
        const startRow = 4;
        // –û—á–∏—Å—Ç–∏–º –ø–µ—Ä–≤—É—é —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ (0-–∏–Ω–¥–µ–∫—Å: 0,1,2) –∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ, –Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç—Ä–æ–∫–∏ 4
        const range = XLSX.utils.decode_range(ws['!ref']);
        // –£–¥–∞–ª—è–µ–º —è—á–µ–π–∫–∏ –≤ —Å—Ç—Ä–æ–∫–∞—Ö 1-3 (1-based) –ø–æ 5 –∫–æ–ª–æ–Ω–æ–∫
        for(let r = 0; r < startRow - 1; r++){
          for(let c = 0; c < 5; c++){
            const cellAddress = XLSX.utils.encode_cell({ r, c });
            if(ws[cellAddress]) delete ws[cellAddress];
          }
        }
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞—á–∏–Ω–∞—è —Å–æ startRow
        for(let r = startRow; r <= range.e.r + 1; r++){
          for(let c = 0; c < 5; c++){
            const cellAddress = XLSX.utils.encode_cell({ r: r - 1, c });
            if(ws[cellAddress]) delete ws[cellAddress];
          }
        }
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ. –ö–∞–∂–¥—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫ –∑–∞–Ω–∏–º–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É.
        let rowIndex = startRow;
        let counter = 1;
        const merges = [];
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∏–ª—è —è—á–µ–π–∫–∏ —Å –≥—Ä–∞–Ω–∏—Ü–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–Ω–æ—Å–∞
        const makeStyleTpl = (wrap=false) => ({
          border: {
            top: {style:'thin'},
            bottom: {style:'thin'},
            left: {style:'thin'},
            right: {style:'thin'}
          },
          alignment: { vertical: 'top', wrapText: wrap }
        });
        for(const it of state.log){
          // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –±–µ–∑ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
          const wsList = it.workers.filter(w => w && w.trim());
          // –û–±—â–∞—è –Ω–æ—Ä–º–∞ —Ä–∞–±–æ—Ç—ã
          const normTotal = parseFloat((Number(it.norm_hours) || 0).toFixed(1));
          // –ß–∏—Å–ª–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–º–∏–Ω–∏–º—É–º 1)
          const workerCount = wsList.length > 0 ? wsList.length : 1;
          // –ù–æ—Ä–º–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –æ–∫—Ä—É–≥–ª—ë–Ω–Ω–∞—è –≤–≤–µ—Ä—Ö –¥–æ 0.1 –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          const perVal = calcPerPerson(normTotal, workerCount);
          const rStart = rowIndex - 1;
          const rCount = wsList.length > 0 ? wsList.length : 1;
          const rEnd = rStart + rCount - 1;
          // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π, –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —è—á–µ–π–∫–∏ —Å —Ä–∞–±–æ—Ç–æ–π
          if(rCount > 1){
            merges.push({ s: { r: rStart, c: 1 }, e: { r: rEnd, c: 1 } });
          }
          if(wsList.length === 0){
            // –ó–∞–ø–∏—Å—å –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
            const r = rowIndex - 1;
            // –ù–æ–º–µ—Ä
            ws[XLSX.utils.encode_cell({ r, c: 0 })] = { t: 'n', v: counter, s: makeStyleTpl(false) };
            // –†–∞–±–æ—Ç–∞
            ws[XLSX.utils.encode_cell({ r, c: 1 })] = { t: 's', v: it.title, s: makeStyleTpl(true) };
            // –ù–æ—Ä–º–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞ (—Ä–∞–≤–Ω–∞ –æ–±—â–µ–π –Ω–æ—Ä–º–µ)
            ws[XLSX.utils.encode_cell({ r, c: 2 })] = { t: 'n', v: perVal, s: makeStyleTpl(false) };
            // –î–∞—Ç–∞
            ws[XLSX.utils.encode_cell({ r, c: 3 })] = { t: 's', v: state.date || '', s: makeStyleTpl(false) };
            // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–ø—É—Å—Ç–æ)
            ws[XLSX.utils.encode_cell({ r, c: 4 })] = { t: 's', v: '', s: makeStyleTpl(true) };
            rowIndex++;
            counter++;
          } else {
            wsList.forEach((w, idx) => {
              const r = rowIndex - 1;
              if(idx === 0){
                // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –Ω–æ–º–µ—Ä, —Ä–∞–±–æ—Ç–∞, –Ω–æ—Ä–º–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞, –¥–∞—Ç–∞, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                ws[XLSX.utils.encode_cell({ r, c: 0 })] = { t: 'n', v: counter, s: makeStyleTpl(false) };
                ws[XLSX.utils.encode_cell({ r, c: 1 })] = { t: 's', v: it.title, s: makeStyleTpl(true) };
                ws[XLSX.utils.encode_cell({ r, c: 2 })] = { t: 'n', v: perVal, s: makeStyleTpl(false) };
                ws[XLSX.utils.encode_cell({ r, c: 3 })] = { t: 's', v: state.date || '', s: makeStyleTpl(false) };
                ws[XLSX.utils.encode_cell({ r, c: 4 })] = { t: 's', v: w, s: makeStyleTpl(true) };
              } else {
                // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π: –Ω–æ—Ä–º–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞, –¥–∞—Ç–∞ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                ws[XLSX.utils.encode_cell({ r, c: 2 })] = { t: 'n', v: perVal, s: makeStyleTpl(false) };
                ws[XLSX.utils.encode_cell({ r, c: 3 })] = { t: 's', v: state.date || '', s: makeStyleTpl(false) };
                ws[XLSX.utils.encode_cell({ r, c: 4 })] = { t: 's', v: w, s: makeStyleTpl(true) };
              }
              rowIndex++;
            });
            counter++;
          }
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω, –Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç—Ä–æ–∫–∏ 2, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        const endRow = rowIndex - 1;
        const newRange = { s: { r: 1, c: 0 }, e: { r: endRow - 1, c: 4 } };
        ws['!ref'] = XLSX.utils.encode_range(newRange);
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —è—á–µ–µ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
        if(merges.length){
          ws['!merges'] = merges;
        }
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—Å—Ç —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º–∏
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ª–∏—Å—Ç —Å —ç—Ç–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const sumSheetName = '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏';
        let idx = wb.SheetNames.indexOf(sumSheetName);
        if(idx !== -1){
          delete wb.Sheets[sumSheetName];
          wb.SheetNames.splice(idx,1);
        }
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        const totals = {};
        for(const it of state.log){
          const wsList = it.workers.filter(Boolean);
          const n = (wsList.length) || 1;
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ –∏ –¥–ª—è —Å—Ç—Ä–æ–∫, —á—Ç–æ–±—ã –∏–∑–±–µ–≥–∞—Ç—å –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
          const per = calcPerPerson(Number(it.norm_hours)||0, n);
          if(wsList.length === 0){
            totals['(–±–µ–∑ –∏–º–µ–Ω–∏)'] = toOneDecimal((totals['(–±–µ–∑ –∏–º–µ–Ω–∏)']||0) + per);
          } else {
            for(const w of wsList){
              totals[w] = toOneDecimal((totals[w]||0) + per);
            }
          }
        }
        const summaryData = [];
        summaryData.push(['–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å','–°—É–º–º–∞, —á']);
        Object.keys(totals).sort((a,b) => a.localeCompare(b, 'ru')).forEach(name => {
          summaryData.push([name, totals[name].toFixed(1)]);
        });
        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        summarySheet['!cols'] = [ {wch: 25}, {wch: 12} ];
        summarySheet['!freeze'] = { xSplit: 0, ySplit: 1, topLeftCell:'A2' };
        summarySheet['!autofilter'] = { ref: 'A1:B1' };
        XLSX.utils.book_append_sheet(wb, summarySheet, sumSheetName);
        // –ü–∏—à–µ–º —Ñ–∞–π–ª
        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        const blob = new Blob([wbout], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        downloadBlob(`narjad_${state.date}.xlsx`, blob);
      }catch(err){
        console.error(err);
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —à–∞–±–ª–æ–Ω–∞: ' + err.message);
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –Ω–∞—Ä—è–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é
    byId('btnSaveLog').addEventListener('click', ()=>{
      if(!state.log || state.log.length === 0){
        alert('–ù–µ—Ç —Ä–∞–±–æ—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        return;
      }
      const rec = {
        id: uuid(),
        date: state.date,
        orderInfo: state.orderInfo,
        log: JSON.parse(JSON.stringify(state.log))
      };
      if(!Array.isArray(state.history)) state.history = [];
      state.history.push(rec);
      // –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π –Ω–∞—Ä—è–¥
      state.log = [];
      state.orderInfo = '';
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
      state.date = new Date().toISOString().slice(0,10);
      save();
      renderAll();
      alert('–ù–∞—Ä—è–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é');
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ (–æ—Ç–∫—Ä—ã—Ç—å/—É–¥–∞–ª–∏—Ç—å)
    byId('historyList').addEventListener('click', (e)=>{
      const openId = e.target?.dataset?.histOpen;
      if(openId){
        const rec = state.history.find(x => x.id === openId);
        if(rec){
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Ä—è–¥ –≤ —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
          state.log = JSON.parse(JSON.stringify(rec.log));
          state.orderInfo = rec.orderInfo || '';
          state.date = rec.date || new Date().toISOString().slice(0,10);
          save();
          renderAll();
          alert('–ù–∞—Ä—è–¥ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }
        return;
      }
      const delId = e.target?.dataset?.histDelete;
      if(delId){
        if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –Ω–∞—Ä—è–¥?')){
          state.history = state.history.filter(x => x.id !== delId);
          save();
          renderHistory();
        }
        return;
      }
    });

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ (JSON)
    byId('btnExportState').addEventListener('click', ()=>{
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π state –≤ JSON –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø—Ä–æ—Ñ–∏–ª—é
      downloadText('kamaz_time_state.json', JSON.stringify(state, null, 2));
    });
    byId('btnImportState').addEventListener('click', ()=>{
      byId('stateFile').click();
    });
    byId('stateFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          if(!obj || !obj.catalog || !obj.log) throw new Error('–ù–µ —Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
          state = obj;
          save(); renderAll();
          alert('–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
        }catch(err){
          alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è: ' + err.message);
        }
      };
      reader.readAsText(f, 'utf-8');
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeHtml(s){
      return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }
    function escapeAttr(s){ return (s??'').toString().replace(/"/g,'&quot;'); }
    function csvEsc(s){
      // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–æ–ª–µ, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–∞–≤—ã—á–∫—É, –∑–∞–ø—è—Ç—É—é, —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏
      s = (s??'').toString();
      if(/[",;\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }
    function downloadText(filename, text){
      // –î–æ–±–∞–≤–ª—è–µ–º BOM –¥–ª—è —Ñ–∞–π–ª–æ–≤ CSV, —á—Ç–æ–±—ã Excel –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª –∫–æ–¥–∏—Ä–æ–≤–∫—É (UTF‚Äë8)
      const isCsv = filename.toLowerCase().endsWith('.csv');
      const bom = '\uFEFF';
      const data = isCsv ? bom + text : text;
      const blob = new Blob([data], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    /**
     * –°–∫–∞—á–∏–≤–∞–µ—Ç –¥–≤–æ–∏—á–Ω—ã–π —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, XLSX)
     * @param {string} filename
     * @param {Blob} blob
     */
    function downloadBlob(filename, blob){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (function init(){
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π: –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      loadGlobalData();
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      load();
    })();
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è service worker –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Ä–∞–±–æ—Ç—ã
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js').catch(function(err) {
          console.warn('ServiceWorker registration failed:', err);
        });
      });
    }
  </script>
</body>
</html>